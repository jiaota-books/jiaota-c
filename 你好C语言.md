## 第二步：你好C语言

做好了准备，第二步就是步入C平原。每个程序员，接触C语言见到的第一个函数，应该都是Hello World吧。

### 你好，C语言！

依照惯例，先上代码：

```c
#include <stdio.h>

int main() {
    printf("Hello World!\n");
    return 0;
}
```

把上面的内容写到一个`hello.c`文件里。C语言的源码文件一般用`.c`作为文件后缀。

这是最常见的，也是最简单的C程序了。即使完全没有编程基础，大概也能明白这段代码在说什么。

- main，大概是主要任务（main quest）之类的意思。那这个用main标记的东西，应该就是整个程序的主要任务吧。那么后面花括号里应该就这个任务的具体内容。
- printf，一看就知道是“打印”
- "Hello World"，一看就知道这是要打印的内容

当然，如果没见过C语言，你大概也会有下面几点疑惑：

- 第一行乱七八糟的 `#include <stdio.h>`完全看不懂
- int是个啥子？和我们有关系吗？
- main后面的括号是啥？
- printf为啥有个`f`？
- "\n"是啥？怎么没打出来？
- 最后的`return 0`是什么？

别看只是一个简单的HelloWorld，其实这段代码包含了很多C语言的信息。

对比一下Python的Hell World就很明显了：

```python
print("Hello World!")
```

简单明了，就一句话：打印”Hello World！“。
C语言呢？突出一个麻烦。
但Python的简洁明了也不是没有代价的，典型的C程序运算速度是Python的10~100倍！
所以我们能看见，Python中凡是遇到需要跑得快的地方，都改用C去实现了。

从这个角度来看，Python并不能算是个独立的编程语言，它是在C的基础上实现的高阶语言。
因此Python才会被戏称为“胶水儿代码”。

那么为什么Python这么简明呢？因为很多事情它帮我们做了。
在程序启动时，在我们看不见的地方，Python程序预先加载了很多东西，包括Python解释器的初始化，各类预设包的加载等等。
每个程序都预先做了这些事情，程序员就不需要做了。Python方便了程序员，但也让实际执行的程序变得更臃肿。

C则不同，把所有的控制权都交给程序员，相应的，所有的事情都要自己做。

下面我们分析一下，这段代码到底做了哪些事情。

### C的Hello World具体做了哪些事

我们从Python的Hello World开始，逐步添加内容，看看C语言代码里程序员多做了哪些事情。


#### 函数的调用


首先，所谓编程，大致的流程就是告诉计算机“你要做什么”。
这里“做什么”分为“做”（任务本身）和“什么”（任务的目标或道具）两个部分。也就是我们自然语言里的谓语和宾语。

Python这里很明显，`print`就是任务本身，而`"Hello World"是任务的目标。把他们用括号联系起来，就是一次任务的执行：

```python
print("Hello World”)
```

编程术语把这类任务叫做**函数**（Function），这个执行的过程叫**函数调用**（Function Call），执行的内容叫做函数的**参数**（Argument）。

在上面的例子里，参数是一段文字，而不是一个数字，而除了文字和数字之外，编程语言还有很多其他**类型**（type）的数据，我们甚至可以定义自己的类型。文字类型通常称为`字符串`类型（String)，而数字类型则根据整数、小数、复数等情况分为不同的具体类型。

在C语言的例子中，

```c
printf("Hello World\n");
```

的效果和Python这段代码一致。但有几个细微区别：

- C用的函数名是`printf`，这里的`f`是“格式化”(format)的意思。在本例中并没有真正的用到格式化的功能，但后面会介绍到。它让`printf`函数可以打印各种类型的数据。
- C的字符串比Python多了一个`\n`字符。注意这里`\`并不是一个单独的字符，而是要和`\n`配合起来，表示特殊字符“换行”。为什么要这么写，是因为换行这类特殊的字符是无法直接表示出来的，我们称之为“控制字符”。类似的控制字符还有`\t`（制表符，也就是键盘上的`Tab`键）等。有趣的是，在Vim编辑器里，换行的按钮就是Ctrl+N。Python为什么不用这么写呢？是因为python的`print`函数会在后面自动加上'\n'，这样确实方便了程序员，但这种隐藏操作有时会有意想不到的结果。在其他语言里，会通过`print`和`println`来区分这两种打印，其中`ln`就是一行(Line)的意思。
- C的函数调用之后还多了一个`;`符号。这个符号是**语句**的结束符。在C里，函数的内容（即`{}`内的函数体）是由多个语句组成的，每个语句都由';'结束。

最后，在C语言里，`printf`这类官方事先写好的程序（称为**标准库**）函数是定义在各自的文件里的。我们在使用它之前必须先把它导入进来。
`#include <stdio.h>`这句话的意思就是从`stdio.h`这个标准库文件里导入所有的函数，这样我们自己的代码中就可以直接使用它了。

`stdio`的意思是`标准I/O`（Standard I/O）。里面定义了不少常用的输入输出相关的操作，例如读写命令行、读写文件等。


#### 函数的创建

除了调用语言本身提供的函数（我们把这些函数的集合称为标准库），还可以自己创造新的函数。

在上面的C语言示例里，`main`函数就是我们创造的。

我们告诉计算机，这里有一个任务，它的名字是`main`，它不需要任何参数，所以参数列表是空的，即`()`。
`{}`里是这个任务具体要执行的操作，本例中做了两件事：
- 第一句调用`printf`打印出"Hello World"信息
- 第二句`return 0`表示执行结束，返回结果是0。

这里的`return`并不是函数，而是C语言内置的命令关键字。任何需要跳出当前执行过程的地方，都可以使用`return`。

综上，自制函数的结构是这样的：

```c
返回类型 函数名(参数列表) {
    语句1;
    语句2;
    ...
}
```

我们的`main`函数返回类型是`int`，即整数(Integer)。这和最后一句返回的`return 0`是对应的。

注：为什么`main`函数要返回一个`0`呢？这是由于操作系统在执行完一个程序之后，需要它在结束时返回一个数值，如果是0，就表示程序运行正常，如果出了错误，就应当返回操作系统定义好的错误码。`return 0`的意思就是，告诉操作系统“我OK了”。

Python或者Java都没有这个返回，是因为这些语言里程序文件并不直接和操作系统打交道，而是通过一个运行环境（Runtime）来执行。这个运行环境负责给操作系统返回值。

再举一个带参数的函数定义的示例：

```c
int add(int a, int b) {
    return a + b;
}
```

这个函数的任务是返回两个整数`a`和`b`的和`a+b`。

如果一个函数什么都不返回，则用`void`表示不返回。`void`这个单词的本意是`虚空`。

```c
void print_with_no_return(const char* message) {
    printf(message);
}
```

这里的`const char*`是一个比较复杂的类型，但它的意思其实比较简单，就是`一串文字`，术语叫**字符串**，在其他的编程语言里，一般用`string`或者简单的`str`来表示。

C为什么用这么复杂的`const char*`来表示，是因为C本来没有字符串类型。我会在后面（这里留个传送门等待未来填补）专门用一节内容来记录C字符串的来龙去脉。

### 小结

C语言的Hello World相对于其他语言来说是比较繁琐的。但这也给我们机会一上手就能接触更多的语言特性：

- 如何导入其他模块
- 如何自定义函数
- 如何调用函数
- 两个基本类型：int和字符串。
- return语句

最后，我们再重新看看HelloWorld的定义：

```c
// 导入标准库的I/O模块，以使用printf函数
#include <stdio.h>

// 自定义的主函数，也是整个程序的入口 
// 返回值：int类型，0表示程序正常完成；其他数值参看操作系统对应的错误码
// 参数：没有参数
int main() {
    // 调用<stdio.h>中的printf函数，打印信息
    printf("Hello World!\n");
    // 返回0，表示程序正常结束。 
    return 0;
}
```

我用注释的方式把本节记录的内容展示了出来。这样读者可以直接在阅读代码时就弄懂代码写的是什么了。

C语言代码中，注释是非常重要的，所以不论是自己写代码，还是阅读别人写的代码，都要多注意注释的作用。

### 如何改进？

我在学习C语言的过程中一直抱有一个目的，那就是基于C创造一个新语言。

在学习C的特性时，我总会不由自主的思考：如果重新设计C，我会如何改进它？

或者说，如果我要设计一个新语言，作为“更好的C”来替代它，那这个语言应该是什么样的？

以后的每一节我都会把这些思考记录下来。我暂时把这个语言叫做“Z语言”。

本节的Hello World给我的第一印象就是“繁琐”。整个程序中，对程序员而言真正有意义的逻辑就只有`printf("Hello World!")`那一句话。

其他的代码都是在跟外部环境打交道：

- `#include`语句是在跟编译器和标准库打交道
- 返回值int和`return 0`语句在跟执行本程序的操作系统打交道
- `\n`在和命令行打交道

他们可以统称为杂务代码（术语是脚手架代码，boilerplate）。

而减少杂务的方法之一就是制定惯例。这些杂务要处理的情况往往是千篇一律的，因此我们可以订制默认惯例，当程序员没有指定时，让编译器去默认惯例里寻找。

这种定制惯例的思路在工程实践中非常常见。用通俗的话就是“你不说就当默认了”。
例如在Linux系统中，我们直接运行一个命令，系统会自动先去`/bin/`、`/usr/bin`和`/usr/local/bin`里寻找，这些目录中的程序就不需要用户打出全部路径了。
在Windows中，也有这样的默认程序目录：`C:/windows`和`C:/windows/system32`。

Python就是通过这样的方式省略了上面几个杂务代码：

1. Python默认会加载一堆全局函数，`print`就是其中之一，原因很简单，它实在是太常用了。而那些标准库中不那么常用的函数，还是要像C那样先导入进来，例如`import os`。
2. Python的脚本可以直接运行语句，而不需要指定`main`函数，这样就省去了`main`函数的定义框架。当然，Python也提供了类似`main`函数的方法，让程序员可以更好地组织代码。
3. Python的运行环境会自动根据脚本的执行状况来返回不同的值。当没有错误出现的时候，返回0。
4. 因为大部分情况下打印函数都需要添加换行符，所以Python干脆把换行作为默认状态了。如果想不换行，反而要更麻烦地多指定一个参数：`print("Hello", end="")`

第1条，默认的全局函数，是有代价的：所有的程序都会加载一堆可能用不上的函数，不但程序本身体积会变大，也会影响运行时的缓存命中率。所以统一导入，我认为是不可取的。所以Z语言不会有这个功能。

第2条，类脚本话的执行，配合上导入，也会遇到一些问题，最主要的就是被导入的程序中的语句是否也执行？导入多个文件时，这些语句的执行顺序怎么确定？尤其是有交叉重复导入的情况时，会导致情况变得非常复杂。所以我也不想采用这个方法。

第3条，默认返回0，再通过其他的方式返回错误码。Python是通过`throw`的方式返回错误码的，但C语言里并没有这种机制。老版本的C语言倒是有一种默认惯例：如果函数定义时不指定返回类型，那么默认就是`int`；如果这个函数没写`return`语句，那么默认返回`0`。这样做的话，我们的Hello World会变成：

```c
main() {
    printf("Hello World!\n");
}
```

第4条，其实最简单的办法就是提供两个不同的函数，一个自动加换行(println)，里另一个不加(print)。新版的C++就有这两个函数（std::println和std::print），这样程序员可以根据自己的需求来选择，并不需要多写`\n`字符。当然这样做也没有省出多少按键来，因此C当初也就没有采取这个了，但C的默认情况显然反了，因此程序员经常会犯下忘了添加'\n'的情况。

根据上面的分析，Z语言会做出如下改变：

```z
use io
main {
  io.println("Hello World")
}
```

注意，这里还做出了3个改变：

- `#include`改为`use`，既节省了字符，同时也是完全不同的实现机制：Z语言会采用更现代化的模块导入机制，而不是C的传统文件include机制。这一部分会在后面详细记录。
- 如果函数定义并没有参数，那么可以直接省略掉'()'。
- 函数内容里的语句并不需要`;`结束，直接用`\n`换行来判断就足够了。也就是说，每一行是一条语句。

Z语言的具体设计和实现，我会记录在另一本开源书[《脚踏实地Z语言》](https://gitee.com/jiaota/jiaota-z)中，敬请期待。

